From: Cordell Bloor <cgmb@slerp.xyz>
Date: Sun, 26 Mar 2023 19:14:09 -0600
Subject: expand architecture support

Expand support from Navi 21 to the whole Navi family.

Forwarded: https://github.com/ROCm/rccl/pull/740
---
 src/collectives/device/prims_ll128.h  |  9 ++++++++-
 src/collectives/device/prims_simple.h | 12 ++++++++++--
 src/include/devcomm.h                 |  2 +-
 3 files changed, 19 insertions(+), 4 deletions(-)

--- a/src/collectives/device/prims_ll128.h
+++ b/src/collectives/device/prims_ll128.h
@@ -11,6 +11,14 @@
 
 #define NCCL_LL128_FLAGTHREAD (NCCL_LL128_LINEELEMS-1)
 
+#ifndef RCCL_USE_WBINVL1_VOL
+#if defined(__GFX8__) || defined(__GFX9__)
+#define RCCL_USE_WBINVL1_VOL 1
+#else
+#define RCCL_USE_WBINVL1_VOL 0
+#endif
+#endif
+
 template<typename T, typename RedOp, typename Fan, int Direct, int P2p>
 class Primitives<T, RedOp, Fan, Direct, ProtoLL128, P2p>:
   public PrimitivesWithoutDirect<Primitives<T, RedOp, Fan, Direct, ProtoLL128, P2p>> {
@@ -297,7 +305,7 @@
       }
     }
 
-#if !defined(__gfx1030__) && !defined(__gfx1100__) && !defined(__gfx1101__) && !defined(__gfx1102__)
+#if RCCL_USE_WBINVL1_VOL
     if (tid == 0) __asm__ __volatile__("buffer_wbinvl1_vol");
 #endif
     /************************ Send **************************/
--- a/src/collectives/device/prims_simple.h
+++ b/src/collectives/device/prims_simple.h
@@ -9,6 +9,14 @@
 #include "npkit/npkit.h"
 #endif
 
+#ifndef RCCL_USE_THREADFENCE_SYSTEM
+#if defined(__GFX10__) || defined(__GFX11__)
+#define RCCL_USE_THREADFENCE_SYSTEM 1
+#else
+#define RCCL_USE_THREADFENCE_SYSTEM 0
+#endif
+#endif
+
 template<typename T, typename RedOp, typename Fan, int Direct,
          int SlicePerChunk, int StepPerSlice, int Unroll, int P2p>
 class Primitives<
--- a/src/include/devcomm.h
+++ b/src/include/devcomm.h
@@ -51,7 +51,7 @@
   int4 i4;
 };
 
-#if defined(__gfx1030__)
+#if defined(__GFX10__) || defined(__GFX11__)
 #define WARP_SIZE 32
 #else
 #define WARP_SIZE 64
