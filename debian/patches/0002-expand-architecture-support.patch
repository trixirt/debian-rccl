From: Cordell Bloor <cgmb@slerp.xyz>
Date: Sun, 26 Mar 2023 19:14:09 -0600
Subject: expand architecture support

Expand support from Navi 21 to the whole Navi family.

Forwarded: no
---
 src/collectives/device/prims_ll128.h  |  9 ++++++++-
 src/collectives/device/prims_simple.h | 12 ++++++++++--
 src/include/devcomm.h                 |  2 +-
 3 files changed, 19 insertions(+), 4 deletions(-)

diff --git a/src/collectives/device/prims_ll128.h b/src/collectives/device/prims_ll128.h
index bd484a4..3bb85e1 100644
--- a/src/collectives/device/prims_ll128.h
+++ b/src/collectives/device/prims_ll128.h
@@ -9,6 +9,13 @@
 
 #define NCCL_LL128_FLAGTHREAD (NCCL_LL128_LINEELEMS-1)
 
+#ifndef RCCL_USE_WBINVL1_VOL
+#if defined(__GFX8__) || defined(__GFX9__)
+#define RCCL_USE_WBINVL1_VOL 1
+#else
+#define RCCL_USE_WBINVL1_VOL 0
+#endif
+#endif
 
 template<typename T, typename RedOp, typename Fan, int Direct, int P2p>
 class Primitives<T, RedOp, Fan, Direct, ProtoLL128, P2p>:
@@ -287,7 +294,7 @@ class Primitives<T, RedOp, Fan, Direct, ProtoLL128, P2p>:
       }
     }
 
-#if !defined(__gfx1030__)
+#if RCCL_USE_WBINVL1_VOL
     if (tid == 0) __asm__ __volatile__("buffer_wbinvl1_vol");
 #endif
     /************************ Send **************************/
diff --git a/src/collectives/device/prims_simple.h b/src/collectives/device/prims_simple.h
index bd58deb..096c9a3 100644
--- a/src/collectives/device/prims_simple.h
+++ b/src/collectives/device/prims_simple.h
@@ -9,6 +9,14 @@
 #include "npkit/npkit.h"
 #endif
 
+#ifndef RCCL_USE_THREADFENCE_SYSTEM
+#if defined(__GFX10__) || defined(__GFX11__)
+#define RCCL_USE_THREADFENCE_SYSTEM 1
+#else
+#define RCCL_USE_THREADFENCE_SYSTEM 0
+#endif
+#endif
+
 template<typename T, typename RedOp, typename Fan, int Direct,
          int SlicePerChunk, int StepPerSlice, int Unroll, int P2p>
 class Primitives<
@@ -330,7 +338,7 @@ private:
 
         }
         barrier(); // This barrier has a counterpart in following loop
-#if defined(__gfx1030__)
+#if RCCL_USE_THREADFENCE_SYSTEM
 	if (Send && (flags & RolePostSend) && index == 0) __threadfence_system();
 #endif
 	__syncwarp();
@@ -352,7 +360,7 @@ private:
         waitPeer<DirectRecv, DirectSend, Recv, Send, Src, Dst>(0, 0, 0, 0);
       }
       barrier(); // Has couterpart in preceding worker-only loop.
-#if defined(__gfx1030__)
+#if RCCL_USE_THREADFENCE_SYSTEM
       if (Send && (flags & RolePostSend) && sliceSize > 0 && index == 0) __threadfence_system();
 #endif
       __syncwarp();
diff --git a/src/include/devcomm.h b/src/include/devcomm.h
index 0061f77..37f1e48 100644
--- a/src/include/devcomm.h
+++ b/src/include/devcomm.h
@@ -55,7 +55,7 @@ union ncclLLFifoLine {
   int4 i4;
 };
 
-#if defined(__gfx1030__)
+#if defined(__GFX10__) || defined(__GFX11__)
 #define WARP_SIZE 32
 #else
 #define WARP_SIZE 64
